/*****************************************************************
File:         readSlideAndKeyValue.ino
Description:  將 BMK54T004 模組的 IIC 介面連接到 Arduino 的 Wire，
              同時將 INT 介面連接到 Arduino 的 PIN2。
              當按鈕被按下或滑桿被觸碰時，Arduino 將透過序列埠監視器
              輸出按鍵與滑桿的狀態值。
******************************************************************/

// 引入 BMK54T004 按鍵滑桿模組的專用函式庫標頭檔
// 此模組結合了按鍵與滑桿（滑動電位器/觸控滑桿）功能
#include "BMK54T004.h"

// 建立 BMK54T004 類別的物件 BMK54，並指定中斷腳位與 I2C 通訊介面
// 參數說明：
// 第一個參數：中斷腳位編號（此處為 2，對應 Arduino 的 D2 腳）
// 第二個參數：I2C 通訊物件指標（此處使用預設的 Wire）
BMK54T004 BMK54(2, &Wire); // 使用預設 Wire（I2C0）通訊，中斷腳位為 D2

// 以下是針對不同硬體平台或接線方式的替代設定：
// BMK54T004 BMK54(22, &Wire1); // 若在 BMduino 上使用 Wire1（I2C1），請取消此行的註解
// BMK54T004 BMK54(25, &Wire2); // 若在 BMduino 上使用 Wire2（I2C2），請取消此行的註解

// 初始化設定函式，在 Arduino 啟動時只會執行一次
void setup() 
{
  // 啟動序列埠通訊，設定傳輸速率為 9600 bps：
  // 用於將按鍵與滑桿狀態資訊輸出到電腦的序列埠監視器（Serial Monitor）
  Serial.begin(9600);
  
  // 初始化 BMK54T004 按鍵滑桿模組：
  // 1. 設定 I2C 通訊參數與時脈
  // 2. 初始化中斷腳位設定（設定為輸入模式並啟用上拉電阻）
  // 3. 重置模組內部暫存器至預設狀態
  // 4. 設定基本工作參數
  BMK54.begin(); 
  
  // 設定所有通道（包括按鍵和滑桿）的觸發閾值等級：
  // 參數 2 表示中等的觸發靈敏度
  // 可調整範圍通常為 1-4（1:最低靈敏度，4:最高靈敏度）
  // 此設定會影響觸控偵測的敏感度，避免誤觸或環境干擾
  BMK54.setAllThresholdLevel(2);
} 

// 主迴圈函式，Arduino 啟動後會不斷重複執行此函式
void loop() 
{
    // 檢查 BMK54T004 模組的中斷狀態：
    // getINT() 函式會讀取模組的 INT 腳位狀態或內部中斷標誌
    // 返回值為 0 表示有觸控事件發生（按鍵按下或滑桿觸碰）
    // 通常為低電平有效（low-active）的中斷訊號
    if(BMK54.getINT() == 0)
    {          
        // 輸出滑桿數值：
        // 1. 先輸出標籤文字 "SlideValue:"
        Serial.print("SlideValue:");
        
        // 2. 讀取滑桿的當前數值並輸出：
        //    readSlideValue() 函式透過 I2C 讀取滑桿的類比/數位轉換值
        //    返回值可能為 0-255（8位元解析度）或 0-1023（10位元解析度）
        //    具體範圍取決於模組的設計規格
        //    數值越大通常表示滑桿位置越靠近某一端
        Serial.println(BMK54.readSlideValue());             

        // 輸出按鍵數值：
        // 1. 先輸出標籤文字 "KeyValue:"
        Serial.print("KeyValue:");
        
        // 2. 讀取按鍵的狀態數值並輸出：
        //    readKeyValue() 函式透過 I2C 讀取按鍵狀態暫存器
        //    返回值是一個位元組（byte），每位元（bit）代表一個按鍵的狀態
        //    通常位元值為 1 表示按鍵被按下，0 表示未按下（或依模組規格相反）
        //    BMK54T004 中的 "004" 可能表示有 4 個按鍵
        Serial.println(BMK54.readKeyValue());      
        
        // 注意：此處沒有延遲函式（delay），因此當按鍵/滑桿持續被觸碰時
        // 會連續快速地輸出數值，可能造成序列埠監視器訊息過多
        // 實際應用中可考慮加入適當延遲或使用狀態變化偵測
    }  
    
    // 主迴圈會持續快速執行，不斷檢查中斷狀態
    // 這種方式稱為「輪詢（polling）」，而非使用硬體中斷服務函式
}

/*****************************************************************
補充說明：

1. 硬體連接：
   - VCC：連接至 3.3V 或 5V（依模組規格）
   - GND：連接至共同接地
   - SDA：連接至 Arduino 的 SDA 腳（通常為 A4 或對應的 SDA 腳）
   - SCL：連接至 Arduino 的 SCL 腳（通常為 A5 或對應的 SCL 腳）
   - INT：連接至 Arduino 的 D2 腳（此範例設定）

2. 模組功能：
   - BMK54T004 結合了觸控按鍵與滑桿功能
   - "54" 可能表示模組型號系列
   - "T004" 可能表示有 4 個觸控按鍵（Touch 4 keys）
   - 滑桿可能為線性電位器或觸控滑桿

3. 閾值設定（setAllThresholdLevel）：
   - 用於設定觸控偵測的靈敏度
   - 等級 1：低靈敏度，需要較大觸碰壓力/面積
   - 等級 2：中靈敏度（預設或平衡設定）
   - 等級 3：高靈敏度
   - 等級 4：最高靈敏度，可能容易受環境干擾
   - 應根據實際應用環境（濕度、溫度、面板材質）調整

4. 中斷機制：
   - 模組偵測到任何觸控事件（按鍵或滑桿）時，會拉低 INT 腳位
   - Arduino 程式透過 getINT() 函式查詢此狀態
   - 這種設計允許主控器在無事件時進入低功耗模式

5. 輸出範例：
   當觸碰滑桿至中間位置並按下第一個按鍵時，序列埠監視器可能顯示：
   SlideValue:128
   KeyValue:1
   
   當同時按下多個按鍵時，KeyValue 會是各按鍵對應位元的組合值

6. 注意事項：
   - 確保 I2C 線路有適當的上拉電阻（通常 4.7kΩ-10kΩ）
   - 避免 INT 腳位浮接（floating），模組內部通常已有上拉
   - 在電氣噪聲較大的環境中，可能需要降低靈敏度或增加濾波
******************************************************************/