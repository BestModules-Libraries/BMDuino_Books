// ================================================================
// =============== 全域變數宣告區 (Global Variables) ===============
// ================================================================

// 宣告三個全域變數，用於儲存 WiFi 模組相關資訊
String MacData;   // 儲存目前裝置的 WiFi MAC Address（網路卡的唯一識別碼）
String SSIDData;  // 儲存目前連線的 WiFi 熱點名稱 (SSID)
String IPData;    // 儲存 WiFi 連線後由路由器分配的 IP 位址
 
// =============== 感測器資料全域變數宣告==================
// 注意：以下變數應在 DHTLib.h 或其他地方宣告，這裡補充說明：
// float TValue;  // 儲存溫度值（單位：攝氏度）
// float HValue;  // 儲存濕度值（單位：百分比）

// ================================================================
// =============== 外部函式庫引入區 (Library Includes) ================
// ================================================================

// ------- 感測模組函式與外部函式引用宣告區 -----------
#include <String.h>    // Arduino 內建字串處理函式庫（用於字串操作）
#include "TCP.h"       // 引用 ESP-12F WiFi 模組 (BMCOM BMC81M001) 自訂模組（處理 WiFi 連線）
#include "DHTLib.h"    // 自訂溫溼度感測模組函式庫（讀取 DHT 溫溼度感測器資料）
#include "OledLib.h"   // 自訂 OLED 顯示模組函式庫（提供 OLED 初始化、文字繪製、清屏等功能）
#include "MQTTLib.h"   // MQTT 通訊協定函式庫（用於 MQTT 伺服器連線與訊息發佈）
#include "commlib.h"   // 通訊函式庫（包含通用通訊功能）

// ================================================================
// =============== 自定義函式宣告區 (Function Declarations) =======
// ================================================================

// 函式宣告：初始化所有感測模組
void initSensor();

// 函式宣告：初始化整體系統
void initAll();

// 函式宣告：初始化 WiFi 網路連線
void INITWIFI();

// 函式宣告：顯示標題文字於 OLED 指定列（第一列通常為標題）
void showTitleonOled(String ss, int row);

// 函式宣告：顯示 IP 位址於 OLED 指定列
void showIPonOled(String ss, int row);

// 函式宣告：顯示裝置 Device ID（MAC 位址）於 OLED 指定列
void showDeviceonOled(String ss, int row);

// 函式宣告：顯示 WiFi 基本參數（MAC、SSID、IP）於序列埠
void ShowWiFiInformation();


// ================================================================
// ===================== setup() 函式 =============================
// ================================================================
// 功能：Arduino 啟動時執行一次，用於系統初始化設定

void setup() 
{
    // 步驟1：初始化整體系統（序列埠、感測器等）
    initAll();
    delay(200);  // 延遲200毫秒，確保系統穩定
    
    // 步驟2：顯示溫溼度感測器資訊（測試感測器是否正常）
    ShowDHTInformation();   // 印出溫溼度感測器產品所有資訊 
    
    // 步驟3：WiFi 連線處理
    INITWIFI();     // 初始化 WiFi 網路，並取得 SSID、IP 與 MAC 資料 
    
	// 步驟4：MQTT Broker 初始化（僅在 WiFi 連線成功時執行）
	if (Wifi.getStatus())  // 檢查 WiFi 連線狀態是否正常
	{
		initMQTT(); // 初始化 MQTT 伺服器連線
		Serial.println("MQTT OK");  // 序列埠輸出 MQTT 初始化成功訊息
	}
    
    // 步驟5：OLED 顯示示範程式碼
    clearScreen();  // 清除 OLED 螢幕
    
    // 顯示 BEST MODULE LOGO 圖片
    // 參數說明：drawPicture(x座標, y座標, 圖片資料, 寬度, 高度)
    drawPicture(0, 0, BestModule_LOGO, 128, 64);  // 在 OLED 上繪製公司標誌
    delay(2000);  // 顯示標誌2秒鐘
    
    // 清除螢幕並顯示系統標題
    clearScreen();  // 清除螢幕
    showTitleonOled("Temp & Humid SyS", 0);  // 在第一列顯示系統標題
 
    // 步驟6：序列埠輸出進入主迴圈訊息
    Serial.println("Enter Loop()");  // 表示系統初始化完成，開始主迴圈
}

// ================================================================
// ===================== loop() 函式 ==============================
// ================================================================
// 功能：Arduino 主迴圈，重複執行，實現主要系統功能

void loop() 
{
    // ---------- 步驟1：讀取並顯示溫溼度資料 ----------
    // 從 DHT 感測器讀取濕度數值
    HValue = readHumidity();  // 讀取濕度值（百分比）
    Serial.print("Humidity : ");
    Serial.print(HValue);     // 序列埠輸出濕度值
    Serial.print(" %    ");   // 濕度單位
    
    // 從 DHT 感測器讀取溫度數值
    TValue = readTemperature();  // 讀取溫度值（攝氏度）
    Serial.print("Temperature : ");
    Serial.print(TValue);        // 序列埠輸出溫度值
    Serial.println(" °C ");      // 溫度單位
    
    // 在 OLED 上顯示溫溼度資料
    showMsgonOled("Temp:" + String(TValue), 2);   // 在第2列顯示溫度
    showMsgonOled("Humid:" + String(HValue), 4);  // 在第4列顯示濕度

    // ---------- 步驟2：檢查網路狀態並發送資料 ----------
    
    if (Wifi.getStatus() != 2)  // 判斷網路連線不正常（狀態不等於2）
    { 
        // 網路連線異常，重新初始化 WiFi
        INITtWIFI();  // 重新連線 WiFi 網路
        Serial.println("WIFI OK");  // 輸出 WiFi 重新連線成功訊息
        MQTTPublish();  // 發送感測資料到 MQTT Broker
    }
    else  // 網路連線正常
    {
        Serial.println("WIFI OK");  // 輸出 WiFi 連線正常訊息
        MQTTPublish();  // 發送感測資料到 MQTT Broker
    }

    // ---------- 步驟3：延遲等待 ----------
    delay(120000);  // 延遲120秒（2分鐘）後再次執行迴圈
}

// ================================================================
// =============== 自定義函式實作區 (Function Implementations) ====
// ================================================================

// ---------------------------------------------------------------
// 函式名稱：initSensor()
// 功能：初始化所有感測模組
// 參數：無
// 傳回值：無
// ---------------------------------------------------------------
void initSensor()
{
    // 步驟1：初始化 OLED 顯示模組
    initOled();    // 初始化 OLED 12864 (0.96吋 OLED BMD31M090)
    delay(2000);   // 延遲 2 秒，等待顯示模組穩定運作
    
    // 步驟2：初始化 DHT 溫溼度感測器
    initDHT();     // 初始化 DHT 感測器模組
    
    // 步驟3：顯示 DHT 感測器資訊（用於測試和驗證）
    ShowDHTInformation();   // 印出溫溼度感測器產品所有資訊
}

// ---------------------------------------------------------------
// 函式名稱：initAll()
// 功能：初始化整體系統（Arduino 系統層級初始化）
// 參數：無
// 傳回值：無
// ---------------------------------------------------------------
void initAll()
{
    // 步驟1：初始化序列埠通訊
    Serial.begin(9600);  // 啟動序列埠，速率 9600 bps（位元/秒）
    
    // 步驟2：輸出系統啟動訊息
    Serial.println("System Start.....");  // 印出"System Start....."
    
    // 步驟3：初始化所有感測模組
    initSensor();  // 呼叫感測器初始化函式
}

// ---------------------------------------------------------------
// 函式名稱：INITWIFI()
// 功能：初始化 WiFi 網路連線
// 參數：無
// 傳回值：無
// 備註：此函式封裝了 WiFi 初始化和資訊顯示的功能
// ---------------------------------------------------------------
void INITWIFI()
{
    initWiFi();             // 連線 WiFi（實際連線動作）
    ShowWiFiInformation();  // 顯示 MAC / SSID / IP（連線成功後顯示資訊）
}

// ---------------------------------------------------------------
// 函式名稱：ShowWiFiInformation()
// 功能：顯示目前 WiFi 連線相關資訊（MAC、SSID、IP）於序列埠
// 參數：無
// 傳回值：無
// 流程：
//   1. 取得並顯示 MAC 位址
//   2. 取得並顯示 SSID（WiFi 熱點名稱）
//   3. 取得並顯示 IP 位址
// ---------------------------------------------------------------
void ShowWiFiInformation()
{
    // ---------- 步驟1：取得並顯示 MAC 位址 ----------
    Serial.println("---MAC Address----");  // 在序列埠輸出標題文字
    MacData = GetMAC();   // 呼叫自訂函式 GetMAC()，取得目前裝置的 MAC Address
                          // 並將結果存入全域變數 MacData
    Serial.println(MacData);  // 印出裝置的 MAC Address
    Serial.println("");        // 空一行，使顯示格式更清楚
    
    // ---------- 步驟2：取得並顯示 SSID ----------
    Serial.println("---wifi access point----");  // 顯示目前使用的 WiFi AP 資訊標題
    SSIDData = GetSSID();  // 呼叫 GetSSID() 取得目前連線的 WiFi SSID
                          // 並儲存回全域變數 SSIDData
    Serial.println(SSIDData);  // 印出目前連線的 WiFi 熱點名稱 (SSID)
    
    // ---------- 步驟3：取得並顯示 IP 位址 ----------
    Serial.println("---Show IP Address----");  // 顯示 IP 位址標題
    IPData = GetIP();  // 呼叫自訂函式 GetIP() 取得目前 WiFi 分配到的 IP 位址
                      // 並儲存回全域變數 IPData
    Serial.println(IPData);  // 在序列埠輸出 IPAddress，例如：192.168.1.105
}

// ================================================================
// ===================== 補充說明 ================================
// ================================================================
/*
系統架構總結：
1. 系統啟動流程：setup() → initAll() → 各模組初始化
2. 主迴圈任務：讀取感測器資料 → OLED 顯示 → 網路狀態檢查 → MQTT 發送
3. 網路恢復機制：當 WiFi 斷線時自動重新連線
4. 資料發送間隔：每 2 分鐘發送一次感測資料

注意事項：
1. 延遲時間 120000ms（2分鐘）可依需求調整
2. 需要確保 MQTT 伺服器地址和主題在 MQTTLib.h 中正確設定
3. OLED 顯示函式需確保字串長度不超過顯示範圍
4. WiFi 連線需要正確的 SSID 和密碼設定
*/
